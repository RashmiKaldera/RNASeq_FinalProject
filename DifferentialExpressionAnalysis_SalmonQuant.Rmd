---
title: "Differential Gene Expression Analysis Using Salmon Quantification Data"
author: "Rashmi Dissasekara"
date: "2025-05-01"
output:
  pdf_document: default
  html_document: default
---
## Overview
This R Markdown file performs differential gene expression (DGE) analysis using RNA-seq quantification data generated by Salmon, a lightweight and accurate tool for transcript-level quantification. The data used here corresponds to the experimental design and conditions reported in [PMID: 40055794](https://pubmed.ncbi.nlm.nih.gov/40055794/), which investigates transcriptional changes under different treatment conditions in breast cancer cell lines.

The analysis includes:
- Importing quantification data with tximport
- Differential gene expression analysis using DESeq2
- Visualization using PCA plots
- Over-representation Analysis (OR) using GO gene datasets

### Code: Package Installation

```{r,results='hide', quiet=TRUE, message=FALSE}


if (!require("readr")) {
  install.packages("readr")}

if (!require("ggplot2", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install("ggplot2")

if (!require("DESeq2", quietly = TRUE))
  BiocManager::install("DESeq2")

if (!require("ggrepel", quietly = TRUE))
  BiocManager::install("ggrepel")

if (!require("tximport", quietly = TRUE))
  BiocManager::install("tximport")

if(!require("tidyverse", quietly=TRUE))
  install.packages("tidyverse")

if (!require("ClusterProfiler", quietly=TRUE))
  BiocManager::install("clusterProfiler")


```

```{r results='hide'}
library(tximport)
library(readr)
library(DESeq2)
library(ggrepel)
library("tidyverse")
library(clusterProfiler)
```

### Load Sample Metadata
We load the metadata file `samples.csv`, which should contain columns like `Sample` and `Condition`. These columns are used to associate each sample with its experimental condition.

```{r}
samples <- read.csv("samples.csv", header = TRUE)
samples$Condition
samples$Sample
```

### Define and Name Paths to Salmon Quantification Files
Here we construct the file paths to the `quant.sf` files generated by Salmon for each sample. It then prints the paths and checks if the files exist.Finally, it assigns sample names to each file path for easy identification.

```{r results='hide'}
files <- file.path(("salmon_quant"), samples$Sample, "quant.sf")
print(files)
file.exists(files)
```

```{r}
names(files) <- samples$Sample

```

### Load and Preview Transcript-to-Gene Mapping File
Now we load the `tx2gene.tsv` file, which maps transcript IDs to gene IDs, and previews the first few rows to ensure the file was loaded correctly.

```{r}
tx2gene <- read.delim("tx2gene.tsv", header = FALSE, stringsAsFactors = FALSE)

head(tx2gene)

```

### Filter and Load Data for T47D Cell Line
In this section, we filter the metadata to select samples from the T47D cell line. We then construct the file paths to their corresponding `quant.sf` files and load the Salmon data using `tximport`.

```{r}
# Filter for T47D samples
T47D_samples <- samples[grep("T47D", samples$Sample), ]

#Construct the file paths to the quant.sf files
T47D_files <- file.path("salmon_quant", T47D_samples$Sample, "quant.sf")

#Use tximport to load the Salmon data
txi_T47D <- tximport(T47D_files, type = "salmon", tx2gene = tx2gene, ignoreTxVersion = TRUE)
```

### Create DESeq2 Dataset for T47D Cell Line
This step constructs a DESeq2 dataset (`dds_T47D_Txi`) from the `tximport` data for the T47D cell line. The design formula specifies the experimental condition as the variable of interest.

```{r}
dds_T47D_Txi <- DESeqDataSetFromTximport(txi_T47D,
                                   colData = T47D_samples,
                                   design = ~ Condition)
```

### Pre-filtering and DESeq2 Analysis for T47D Cell Line
This section performs pre-filtering to retain genes with at least 50 counts in a minimum of 3 samples. Then, it runs DESeq2 for differential expression analysis and relevels the condition factor to set "T47D-Par" as the reference level.

```{r prefilter}


smallestGroupSize <- 3
keep <- rowSums(counts(dds_T47D_Txi) >= 50) >= smallestGroupSize
ddsTxi <- dds_T47D_Txi[keep,]

dds <- ddsTxi

rm(ddsTxi)

# factor levels

dds$condition <- relevel(dds$Condition, ref = "T47D-Par")

dds <- DESeq(dds)
res <- results(dds)
res
```

### Data Normalization for T47D Cell Line
We normalize the data using three different methods: variance stabilizing transformation (VST), regularized log transformation (rlog), and a simple normalization transformation (`normTransform`). It then previews the results of the VST method.

```{r normalization}
vsd <- vst(dds, blind=FALSE)
rld <- rlog(dds, blind=FALSE)
# this gives log2(n + 1)
ntd <- normTransform(dds)

head(assay(vsd), 3)
```

### PCA Plot for T47D Cell Line
This section creates a PCA plot using the variance stabilizing transformation (VST) data, colored by the `Condition` variable, to visualize sample clustering based on gene expression.

```{r PCA, echo=FALSE, fig.cap="PCA plot of T47D samples colored by Condition", out.width="80%", fig.height=5, fig.width=7}
pca_plot <- plotPCA(vsd, intgroup="Condition")

# Display the plot in the HTML output
print(pca_plot)


# Save the PCA plot to a separate PDF file
ggsave("PCA_plot_T47D.pdf", plot = pca_plot, width = 7, height = 5)
```

### Filter and Load Data for UCD4 Cell Line
This section filters the metadata to select samples from the UCD4 cell line. It then constructs the file paths to their corresponding `quant.sf` files and loads the Salmon data using `tximport`.

```{r}
# Filter for UCD4 samples
UCD4_samples <- samples[grep("UCD4", samples$Sample), ]

#Construct the file paths to the quant.sf files
UCD4_files <- file.path("salmon_quant", UCD4_samples$Sample, "quant.sf")

#Use tximport to load the Salmon data
txi_UCD4 <- tximport(UCD4_files, type = "salmon", tx2gene = tx2gene, ignoreTxVersion = TRUE)
```
### Create DESeq2 Dataset for UCD4 Cell Line 
We construct a DESeq2 dataset (`dds_UCD4_Txi`) from the `tximport` data for the UCD4 cell line. The design formula specifies the experimental condition as the variable of interest.

```{r}
dds_UCD4_Txi <- DESeqDataSetFromTximport(txi_UCD4,
                                   colData = UCD4_samples,
                                   design = ~ Condition)
```

### Pre-filtering and DESeq2 Analysis for UCD4 Cell Line
This section performs pre-filtering to retain genes with at least 50 counts in a minimum of 3 samples. Then, it runs DESeq2 for differential expression analysis and relevels the condition factor to set "UCD4-Par" as the reference level.

```{r prefilterUCD4}


smallestGroupSize <- 3
keep <- rowSums(counts(dds_UCD4_Txi) >= 50) >= smallestGroupSize
ddsTxiUCD4 <- dds_UCD4_Txi[keep,]

ddsUCD4 <- ddsTxiUCD4

rm(ddsTxiUCD4)

# factor levels

ddsUCD4$condition <- relevel(ddsUCD4$Condition, ref = "UCD4-Par")

ddsUCD4 <- DESeq(ddsUCD4)
res <- results(ddsUCD4)
res
```
### Data Normalization for UCD4 Cell Line 
This section normalizes the data using three different methods: variance stabilizing transformation (VST), regularized log transformation (rlog), and a simple normalization transformation (`normTransform`). It then previews the results of the VST method.

```{r normalizationUCD4}
vsdUCD4 <- vst(ddsUCD4, blind=FALSE)
rldUCD4 <- rlog(ddsUCD4, blind=FALSE)
# this gives log2(n + 1)
ntdUCD4 <- normTransform(ddsUCD4)

head(assay(vsdUCD4), 3)
```

### PCA Plot for UCD4 Cell Line
This section creates a PCA plot using the variance stabilizing transformation (VST) data, colored by the `Condition` variable, to visualize sample clustering based on gene expression.

```{r PCAUCD4, echo=FALSE, fig.cap="PCA plot of UCD4 samples colored by Condition", out.width="80%", fig.height=5, fig.width=7}
pca_plotUCD4 <- plotPCA(vsdUCD4, intgroup="Condition")

# Display the plot in the HTML output
print(pca_plotUCD4)


# Save the PCA plot to a separate PDF file
ggsave("PCA_plot_UCD4.pdf", plot = pca_plotUCD4, width = 7, height = 5)
```
### Extract Differential Expression Results for T47D and UCD4 Comparisons

Here we extract specific pairwise comparisons from the DESeq2 results for both T47D and UCD4 cell lines. These contrasts will help identify differentially expressed genes between resistant and parental conditions.


```{r}
# T47D contrasts
res_T47D_FulvR_vs_Par <- results(dds, contrast = c("Condition", "T47D-FulvR", "T47D-Par"))
res_T47D_TamR_vs_Par <- results(dds, contrast = c("Condition", "T47D-TamR", "T47D-Par"))

# UCD4 contrasts
res_UCD4_FulvR_vs_Par <- results(ddsUCD4, contrast = c("Condition", "UCD4-FulvR", "UCD4-Par"))
res_UCD4_TamR_vs_Par <- results(ddsUCD4, contrast = c("Condition", "UCD4-TamR", "UCD4-Par"))
res_UCD4_EWD_vs_Par <- results(ddsUCD4, contrast = c("Condition", "UCD4-EWD", "UCD4-Par"))
```

### Gene Annotation Using biomaRt

In this section, we annotate all Ensembl gene IDs found in our differential expression results using the biomaRt package. We retrieve gene descriptions, external gene names, and transcript lengths. To avoid redundancy, we retain only the longest transcript for each gene. This annotated table will be useful for downstream analyses like GO enrichment or gene-level summaries.

```{r GO, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


# create an object for the Ensembl Genes v100 mart

if (!requireNamespace("biomaRt", quietly = TRUE)) {
  install.packages("BiocManager")
  BiocManager::install("biomaRt")
}
library(biomaRt)

ensembl <- biomaRt::useMart("ensembl", dataset = "hsapiens_gene_ensembl")


#you can alter host mirror if there are problems for ensembl.
#"https://useast.ensembl.org" (US East)
#"https://asia.ensembl.org" (Asia)
#"https://www.ensembl.org" (default Europe)

# ensembl <- useMart("ensembl", dataset="hsapiens_gene_ensembl", host="https://useast.ensembl.org")


# get gene names and transcript lengths when they exist

# Step 1: Create a union of all Ensembl gene IDs across your DESeq2 results
all_gene_ids <- unique(c(
  rownames(res_T47D_TamR_vs_Par),
  rownames(res_T47D_FulvR_vs_Par),
  rownames(res_UCD4_TamR_vs_Par),
  rownames(res_UCD4_FulvR_vs_Par),
  rownames(res_UCD4_EWD_vs_Par)
))
ann <- getBM(filter="ensembl_gene_id",value=all_gene_ids,attributes=c("ensembl_gene_id","description","transcript_length","external_gene_name"),mart=ensembl)


# pick only the longest transcript for each gene ID

library (dplyr)

ann <- group_by(ann, ensembl_gene_id) %>% 
  summarize(.,description=unique(description),external_gene_name=unique(external_gene_name),transcript_length=max(transcript_length)) %>%
  as.data.frame()

head(ann)
nrow (ann)
#16670

```


### GO Term Annotation for DE Genes

We use biomaRt to retrieve Gene Ontology (GO) annotations for the differentially expressed genes across all comparisons. This includes GO IDs, term names, definitions, and categories such as biological_process, molecular_function, and cellular_component. The resulting annotations are saved to a file for use in downstream enrichment analysis or functional interpretation.


```{r}
go_ann <- getBM(
  filter = "ensembl_gene_id",
  value = all_gene_ids,  # These are your DESeq2 result genes
  attributes = c(
    "ensembl_gene_id",      # The gene ID
    "description",          # Gene description (e.g., "transcription factor SOX2")
    "go_id",                # GO term ID (e.g., "GO:0003677")
    "name_1006",            # GO term name (e.g., "DNA binding")
    "definition_1006",      # GO term definition
    "namespace_1003"        # GO category: "biological_process", "molecular_function", or "cellular_component"
  ),
  mart = ensembl
)


#let's look at the annotation:
filter(ann, description!="") %>% head()

head(ann)
# and Go term:

head(go_ann)

# save go_genes object.
save(go_ann, file = "./go_ann.RData")


# you can later load this go_annotation object for future analyses
# go_ann <- load ("./go_ann.RData")

###
```

### Annotating and Exporting DESeq2 Results

In this step, we merge the differential expression results from DESeq2 with gene annotation data (gene name, description, transcript length). This creates a biologically meaningful result table for each condition comparison. The merged tables are saved as individual .csv files for downstream analysis and reporting.

```{r}
# List your DESeq2 result objects and corresponding labels
result_list <- list(
  T47D_TamR = res_T47D_TamR_vs_Par,
  T47D_FulvR = res_T47D_FulvR_vs_Par,
  UCD4_TamR = res_UCD4_TamR_vs_Par,
  UCD4_FulvR = res_UCD4_FulvR_vs_Par,
  UCD4_EWD = res_UCD4_EWD_vs_Par
)

# Initialize an empty list to store results
merged_results <- list()

# Loop through each DESeq2 result
for (label in names(result_list)) {
  
  res <- result_list[[label]]
  
  # Put results and annotation in the same table
  res_data <- res %>% 
    as.data.frame() %>%
    rownames_to_column(var = "ensembl_gene_id")
  
  # Merge with annotation
  res_ann <- merge(x=res_data, y=ann, by.x="ensembl_gene_id", by.y="ensembl_gene_id", all.x=TRUE)
  
  # Add the result to the list
  merged_results[[label]] <- res_ann
  
  # Optionally, write the merged result to CSV
  write.csv(as.data.frame(res_ann), 
            file = paste0("res_ann_", label, ".csv"))
}

# Check the first merged result (for example, T47D_TamR)
head(merged_results[["T47D_TamR"]])

```
## Over-representation Analysis (OR) 

This section performs ORA using clusterProfiler on differentially expressed genes (padj < 0.1) from each DESeq2 comparison. Enrichment is conducted against Gene Ontology (GO) terms using pre-fetched annotations. Both the DE gene set and the background universe are defined per contrast. The enriched GO terms are saved as .csv files for each condition.

```{r results='hide'}
library(clusterProfiler)


# List of DESeq2 results with their labels
result_list <- list(
  T47D_TamR = res_T47D_TamR_vs_Par,
  T47D_FulvR = res_T47D_FulvR_vs_Par,
  UCD4_TamR = res_UCD4_TamR_vs_Par,
  UCD4_FulvR = res_UCD4_FulvR_vs_Par,
  UCD4_EWD = res_UCD4_EWD_vs_Par
)

# List to store results of ORA
ora_results <- list()

# Loop through each DESeq2 result for ORA
for (label in names(result_list)) {
  res <- result_list[[label]]
  
  # Get the DE genes (padj < 0.1)
  genes <- rownames(res[which(res$padj < 0.1),])
  
  # Get the universe (all genes with non-NA padj)
  univ <- rownames(res[!is.na(res$padj),])

  # Perform Over-Representation Analysis (ORA)
  res_enrich <- enricher(
    gene = genes,
    universe = univ,
    TERM2GENE = go_ann[, c(3, 1)], # Ensure this is the correct mapping
    TERM2NAME = unique(go_ann[, c(3, 4)])
  )
  
  # Store ORA results in the list
  ora_results[[label]] <- res_enrich
  
  # Optionally save the ORA results to CSV
  write.csv(as.data.frame(res_enrich), 
            file = paste0("ORA_results_", label, ".csv"))
}

# check ORA results for a specific comparison, e.g.:
head(ora_results[["T47D_TamR"]])

```

### Filtering for Lipid-Related GO Enrichments

To focus on biologically relevant pathways, this section filters GO enrichment results for terms containing the keyword “lipid.” The filter_lipid_enrichments function searches the enrichment description column and retains only lipid-associated terms across all contrasts. Filtered results are stored in a named list for downstream analysis.

```{r results='hide'}
filter_lipid_enrichments <- function(enrich_obj) {
  if (is.null(enrich_obj)) return(NULL)
  if (!inherits(enrich_obj, "enrichResult")) return(NULL)
  
  df <- enrich_obj@result
  if (is.null(df) || !"Description" %in% colnames(df)) return(NULL)
  
  df %>% dplyr::filter(grepl("lipid", tolower(Description)))
}
  
lipid_ora_results <- lapply(ora_results, filter_lipid_enrichments)
head(lipid_ora_results)

```
### Visualization of Lipid-Associated GO Enrichments

This section visualizes the top lipid-related GO terms (based on adjusted p-value) for each condition using dot plots. The plots display GO terms on the y-axis and their significance (-log10(p.adjust)) on the x-axis, with point size representing gene count and color indicating p-value significance. Only the top 15 most significant terms are shown per contrast.

```{r}
for (label in names(lipid_ora_results)) {
  df <- lipid_ora_results[[label]]
  if (!is.null(df) && nrow(df) > 0) {
    df <- df[order(df$p.adjust), ]
    df_top <- head(df, 15)
    
    p <- ggplot(df_top, aes(x = -log10(p.adjust), 
                            y = reorder(Description, -p.adjust), 
                            size = Count, 
                            color = p.adjust)) +
      geom_point() +
      scale_color_viridis_c(option = "C", direction = -1) +
      labs(title = paste("Lipid ORA -", label),
           x = "-log10(adjusted p-value)", y = "GO term") +
      theme_minimal()
    
    print(p)
    
    # Save as PDF
    ggsave(filename = paste0("Lipid_ORA_", label, ".pdf"), plot = p, width = 7, height = 5)
  }
}

```
### Identifying Upregulated and Downregulated Genes for T47D and UCD4
Here we identify the upregulated and downregulated genes across different conditions for the T47D and UCD4 cell lines. A gene is considered upregulated if its log2 fold change (LFC) is greater than or equal to 2 and its adjusted p-value (padj) is below 0.05. Conversely, a gene is considered downregulated if its LFC is less than or equal to -2 and its padj is below 0.05. The function get_upregulated_genes() and get_downregulated_genes() are used to filter the genes based on these criteria.

```{r}
get_upregulated_genes <- function(res, lfc = 2, padj = 0.05) {
  up_genes <- rownames(res[which(res$padj < padj & res$log2FoldChange >= lfc), ])
  return(up_genes)
}

get_downregulated_genes <- function(res, lfc = 2, padj = 0.05) {
  down_genes <- rownames(res[which(res$padj < padj & res$log2FoldChange <= -lfc), ])
  return(down_genes)
}

# T47D upregulated and downregulated
up_t47d <- unique(c(
  get_upregulated_genes(res_T47D_TamR_vs_Par),
  get_upregulated_genes(res_T47D_FulvR_vs_Par)
))

down_t47d <- unique(c(
  get_downregulated_genes(res_T47D_TamR_vs_Par),
  get_downregulated_genes(res_T47D_FulvR_vs_Par)
))

# UCD4 upregulated and downregulated
up_ucd4 <- unique(c(
  get_upregulated_genes(res_UCD4_TamR_vs_Par),
  get_upregulated_genes(res_UCD4_FulvR_vs_Par),
  get_upregulated_genes(res_UCD4_EWD_vs_Par)
))

down_ucd4 <- unique(c(
  get_downregulated_genes(res_UCD4_TamR_vs_Par),
  get_downregulated_genes(res_UCD4_FulvR_vs_Par),
  get_downregulated_genes(res_UCD4_EWD_vs_Par)
))

```

### Normalized Expression Data for Upregulated and Downregulated Genes

Now we normalize the gene expression data using Variance Stabilizing Transformation (VST) for both T47D and UCD4 cell lines. After transforming the data, the expression values for the upregulated and downregulated genes identified previously are extracted for each cell line. The resulting matrices (up_t47d_mat, down_t47d_mat, up_ucd4_mat, down_ucd4_mat) contain the normalized expression data for these specific gene sets.

```{r}
# Transform the data (vst or rlog)
vsdT47D <- vst(dds, blind = TRUE)
vsdUCD4 <- vst(ddsUCD4, blind = TRUE)

# Subset the normalized expression data
up_t47d_mat <- assay(vsdT47D)[up_t47d, ]
down_t47d_mat <- assay(vsdT47D)[down_t47d, ]
up_ucd4_mat <- assay(vsdUCD4)[up_ucd4, ]
down_ucd4_mat <- assay(vsdUCD4)[down_ucd4, ]

```

### Create Column Annotations for Conditions
The annotations are extracted from the colData of the DESeq2 datasets for each cell line, ensuring that each sample is labeled with its corresponding condition (e.g., T47D-Par, T47D-FulvR, etc.). The resulting data frames, annotation_t47d and annotation_ucd4, will be used for visualizing the data and adding relevant metadata to the heatmap.

```{r}
# Create column annotations for treatments 
annotation_t47d <- as.data.frame(colData(dds)[, "Condition", drop=FALSE])
annotation_ucd4 <- as.data.frame(colData(ddsUCD4)[, "Condition", drop=FALSE])
```

### Generating the heatmaps 

```{r}
install.packages("pheatmap")
library(pheatmap)

# Heatmap for Upregulated T47D
pdf("Upregulated_Genes_T47D.pdf")
pheatmap(head(up_t47d_mat,10), 
         annotation_col = annotation_t47d, 
         show_rownames = TRUE, 
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         main = "Upregulated Genes - T47D (TamR, FulvR, Par)",
         color = colorRampPalette(c("blue", "white", "red"))(100))
dev.off()

# Heatmap for Downregulated T47D
pdf("Downregulated_Genes_T47D.pdf")
pheatmap(head(down_t47d_mat,10), 
         annotation_col = annotation_t47d, 
         show_rownames = TRUE, 
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         main = "Downregulated Genes - T47D (TamR, FulvR, Par)",
         color = colorRampPalette(c("blue", "white", "red"))(100))
dev.off()

# Heatmap for Upregulated UCD4
pdf("Upregulated_Genes_UCD4.pdf")
pheatmap(head(up_ucd4_mat,10), 
         annotation_col = annotation_ucd4, 
         show_rownames = TRUE, 
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         main = "Upregulated Genes - UCD4 (TamR, FulvR, EWD, Par)",
         color = colorRampPalette(c("blue", "white", "red"))(100))
dev.off()

# Heatmap for Downregulated UCD4
pdf("Downregulated_Genes_UCD4.pdf")
pheatmap(head(down_ucd4_mat,10), 
         annotation_col = annotation_ucd4, 
         show_rownames = TRUE, 
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         main = "Downregulated Genes - UCD4 (TamR, FulvR, EWD, Par)",
         color = colorRampPalette(c("blue", "white", "red"))(100))
dev.off()


```

